# .github/workflows/verify.yml
name: Verify
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Show repo info
        run: |
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Files:"; git ls-files | wc -l

  markdown_and_links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v17
        with:
          globs: |
            **/*.md
          config: |
            {
              "line-length": false,
              "no-inline-html": false
            }
      - name: Broken link check (lychee)
        uses: lycheeverse/lychee-action@v2
        with:
          args: >
            --accept 200,206,429
            --scheme https
            --no-progress
            --exclude-path "node_modules|build|dist|Pods|.git"
            --exclude "mailto:*"
            **/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  secrets_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    permissions:
      actions: read
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: github/codeql-action/init@v3
        with:
          languages: auto
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  node_js_mobile:
    if: hashFiles('mobile/package.json') != ''
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: npm
      - run: npm ci
      - run: npm run lint --if-present
      - run: npm run typecheck --if-present
      - run: npm test --if-present
      - run: npm run build --if-present

  python_backend:
    if: hashFiles('backend/requirements.txt') != ''
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements.txt
      - name: Lint (flake8 if present)
        run: |
          if python -c "import flake8" 2>/dev/null; then
            flake8 .
          else
            echo "flake8 not found; skipping."
          fi
      - name: Type check (mypy if present)
        run: |
          if python -c "import mypy" 2>/dev/null; then
            mypy .
          else
            echo "mypy not found; skipping."
          fi
      - name: Unit tests (pytest if present)
        run: |
          if python -c "import pytest" 2>/dev/null; then
            pytest -q || true
          else
            echo "pytest not found; skipping."
          fi
      - name: Smoke start (Uvicorn dry-run)
        run: |
          python -c "import importlib; importlib.import_module('main')"; echo "Main imports OK"
